《计算机网络第7版》(谢希仁) - 笔记



一、 概述



1. 发展 - 三阶段

1. 1. APRANET单网络 -> 互连网络 （1983年TCP/IP协议）
   2. 三级结构的互联网-主干网、地区网、校园/企业网
   3. 多层次ISP（Internet Service Provider）结构

2. 边缘部分的端之间 - 两种通信方式

1. 1. 客户-服务器（C/S）模式
   2. 对等（P2P）方式



3. 核心部分

1. 1. 路由器的分组交换（区别于电路交换的“建立连接” ）：采用“转发存储” message->切成数据段->加header->packet

​		packet（分组）传输时 先暂存 查转发表 “路由选择协议” 选择链路转发 实际上是动态分配传输带宽的策略

​		存在问题：1. 排队的时延； 2. 带宽无法先确定； 3. header开销 （连续传输的大量数据电路还是快一些）



4. 网络性能指标

1. 1. 总时延 = 发送时延(传输时延) + 传播 + 处理 + 排队
   2. 延迟带宽积 = 传播时延 * 带宽
   3. 往返时间（RTT: Round-Trip Time）和 有效数据率 = 数据长度 / （发送时间+RTT）、
   4. 利用率（信道利用率、网络利用率）



5. 网络的体系结构

1. 1. ISO（International Standard Organization）制定OSI/RM简称OSI（Open System Interconnection）

​		要解决：1. 确认链路可用？；2. 锁定目标机？是否在线？文件管理可用？转码？；3. 传输出错如何确保最终收到？

1. 2. 分层要实现功能：1. 差错控制； 2. 流量控制； 3. 分段和重装； 4. 复用和分用； 5. 建立连接和释放

1. 3. OSI 7层； TCP/IP 4层； 讲解 5层
   4. OSI：物理层, 数据链路层, 网络层, 运输层, 会话层, 表示层, 应用层

   5. TCP/IP：网络接口层, 网络层（IP）, 运输层（TCP UDP）, 应用层（SMTP FTP TELNET DNS HTTP）		

   6. 运输层：TCP（传输单位segment报文段）有连接可靠； UDP（传输单位User datagram用户数据报）

   7. 网络层：（传输单位IP数据包）无连接的IP协议

   8. 数据链路层：（传输单位 framing帧）控制信息（同步信息、地址信息、差错控制）

   9. 物理层：（传输单位 bit）

   10. （任何层的数据单元都可叫“分组” 协议数据单元PDU Protocol Data Unit）



​		



二、物理层



1. 任务：即几个特性。机械、电气、功能、过程

2. 串行传输

3. 通信双方信息交互方式：单工、半双工、双工

4. 基带信号（含低频、直流分量），所以要“调制”

5. 1. 基带调制（编码）：不归零(电平)没有自同步能力(提取时钟频率)；归零(脉冲)；Manchester编码(先高后低表1，即中心向下跳变表1)；差分Manchester编码（边界不跳变表1，跳变表0）
   2. 带通调制（利用载波）：调幅AM；调频FM；调相PM

6. 双绞线的类型：无屏蔽双绞线和屏蔽双绞线；

7. 多模光纤：多光线，近距离；单模光纤：衰耗小，100km不用中继器，贵

8. 信道复用技术

9. 1. 频分复用FDM

   2. 时分复用TDM：所占用的时隙是周期性的出现

   3. 1. 统计时分复用STDM（改进的时分复用）：按需动态分配时隙 

   4. 波分复用WDM：光的频分复用。一根光纤上复用两路光载波信号的复用方式。 

   5. 1. 密集波分复用DWDM：一根光纤上复用多路数的光载波信号。 

   6. 码分复用CDM：1bit的信息用多bit来表示。各用户使用经过特殊挑选的不同码型，因此不会互相干扰。 

   7. 1. 码分多址CDMA：有很强的抗干扰能力，频谱类似白噪声，不易被发现。 





三、数据链路层



1. 使用的信道（两种）：点对点信道（PPP协议）和广播信道（CSMA/CD协议）

2. 1. PPP协议

​		简单；只差错检测, 不纠错；不编号；不流量控制

​		首尾F为标志字段0x7E（开始， 结束）；A(address), C(Control)无意义

​		协议字段: 0x0021(PPP帧信息为IP数据包); 0xC021(链路控制协议LCP数据); 0x8021(网络层的控制数据NCP)

​		信息部分不超过1500Byte； FCS(校验码)2Byte

​		异步传输：字符填充 转义符0x7D（要加的有: 0x7E, 0x7D,0x20以下(ASCII控制符)）

​		同步传输：0比特填充 连续5个1填一个0 发现5个1 删去后面的0

​		PPPoE协议：宽带上网的主机所用的链路层协议



1. 2. CSMA/CD协议（半双工, 载波监听多点接入/碰撞检测, Carrier Sense Multiple Access with Collision Detection）

​		不是“码分多址”(CDMA, Code Division）

​		以太网(Ether 局域网)分成LLC(Logic Link Control)和MAC(媒体接入, Medium Access Control)

​		无连接, 不可靠, 不编号, 出错直接丢, 是否重传由高层决定

​		载波监听：发前检测信道；

​		碰撞检测：边发边监听; 重传时机：

​		截断二进制指数退避, 即空闲后等个随机时间再传



2. 链路层三个基本问题：封装成帧, 透明传输, 差错检测

1. 1. 封装成帧：SOH(Start of header)(0000 0001), EOT(End of transmission)(0000 0100)
   2. 透明传输：是一个问题，即如果数据刚好是控制符(SOH, EOT)，接收端无法辨别

​		解决：引入转义符(ESC)(1B: 0001 1011) 如果数据刚好是ESC前面也要加ESC

1. 3. 差错检测：CRC循环冗余校验 余数作为校验码（FCS,frame check sequence）

​		 data(M位)后加校验码(n位)）/约定的数(n+1位) 若余数0则accept；产生校验码是补n位0余约定数产生



3. 以太网MAC层（MAC地址=物理地址, 硬件地址）

​	MAC地址在适配器的ROM中，实际上是适配器地址，与主机所在地点无关 6Byte（48bit）

​	MAC帧格式

​	6+6+2+(46-1500)+4

​	其中46=64-(6+6+2+4)



4. 适配器, 转发器, 集线器, 网桥, 以太网交换机的作用和使用场景 

1. 1. 转发器repeater：物理层
   2. 网桥/桥接器bridge：数据链路层
   3. 路由router：网络层
   4. 网关gateway：网络层以上
   5. 集线器：一, 二层；广播形式
   6. 交换机：二层(链路层)及以上(网络层, 运输层)；有目的地址



​	转发器和网桥仅仅是扩大了网络，实际还是单个网络，使用路由器才使得网络互联





四、网络层



1. 网络层提供的两种服务：虚电路服务和数据报服务 

2. 各层协议及中间设备

应用层：各种应用层协议（HTTP,FTP,SMTP） 

运输层：TCP,UDP。在网络层以上使用的中间设备是网关。用网关连接两个不兼容的系统需要在高层进行协议转换。 

网络层：ICMP,IGMP,IP,RARP,ARP。中间设备是路由器

数据链路层：使用的中间设备是网桥或桥接器 

物理层：物理硬件。 使用的中间设备是转发器 

3. 分类的IP地址 32bit A, B, C类单播；D类多播；E类未使用

​	A类：1～126

​	B类：128.1~191.255

​	C类：192.0.1~233.255.255

​	全1（127.后面还是1）：本地软件环回测试

​	主机号全1表示全网广播

​	网络号全0表示本网络

4. ARP，即地址解析协议，IP地址 —> 物理地址。 

​	工作流程：

​	ARP进程在本局域网上广播发送一个ARP请求分组；

​	在本局域网上所有主机上运行的ARP进程都收到此ARP请求分组；

​	主机B在ARP分组中见到自己的IP地址，就向主机A发送ARP响应分组，并将A的映射写入自己的硬件地址；

​	主机A收到主机B的ARP响应分组后，就在其ARP高速缓存中写入主机B的IP地址到硬件地址的映射。

5. IP数据报

​	首部20～60字节，默认20字节

​	IP数据报不超过576字节，512+60+4字节富余量（假定数据不超过512字节）

​	协议：IP(4), TCP(6), UDP(17), ICMP(1), IGMP(2), IPv6(41), EGP(8), IGP(9), OSPF(89)

6. 子网掩码 和 子网掩码（CIDR）

7. 网际控制报文协议ICMP

1. 1. ICMP差错报告报文
   2. ICMP询问报文（回送请求, 时间戳请求）重要应用：PING	

8. IGP 内部网关协议：在一个自治系统内部使用的路由选择协议。 

1. 1. RIP：路由信息协议，基于距离向量，优点：简单。向邻近路由器发送
   2. OSPF：开放最短路径优先

9. EGP 外部网关协议（BGP）：若源主机和目的主机处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。

10. 路由器的构成：路由选择部分（控制部分，核心构件是路由选择处理机）和分组转发部分（交换结构，一组输入端口，一组输出端口）。 

11. IGMP 网际组管理协议：让连接在本地局域网上的多播路由器知道本局域网上是否有主机参加或退出了某个多播组。 

12. VPN 虚拟专用网：通过一个公用网络建立一个临时的、安全的连接，是一条穿过混乱的公用网络的安全、稳定的隧道。 

13. NAT 网络地址转换：私有地址/专用地址 <—> 全球IP地址

​	NAT不仅完美地解决了lP地址不足的问题；隐藏并保护网络内部的计算机





五、运输层



1. 运输层提供：差错检测、

2. 使用UDP：DNS, RIP(路由信息协议), **TFTP(简单文件传送)**, NFS(远程文件服务器), IGMP(多播)

​	使用TCP：SMTP, POP3, TELNET, HTTP, **FTP(文件传送)**

3. 端口号：16bit（65535个） 

1. 1. 熟知端口号: 0～1023: FTP(21), TELNET(23), SMTP(25), DNS(53), HTTP(80), HTTPS(443)
   2. 登记端口号: 1024~49151
   3. 客户端使用的端口号

4. UDP

​	特点：无连接, 尽最大努力交付, 面向报文, 无拥塞控制, 支持一对一、一对多、多对一、多对多

​	上层应用自己增加可靠性：前向纠错, 重传已丢失报文

​	首部(8 Byte)：2个端口 + 长度 + 校验和

​	伪首部只是临时计算校验和用的	

5. TCP（segment TCP报文段）

1. 1. 特点：面向连接, 一对一, 可靠交付(传输无差错；不管发送方多快，接收方总能来得及处理), 全双工, 面向字节流

   2. 一次发多少由接收方窗口值和拥塞程度决定

   3. 停止等待协议（ARQ自动重传请求）缺点：信道利用率低

   4. 1. 编号；确认前保留副本；超时重传时间比RRT略长

      2. 改进：连续ARQ协议

      3. 1. 滑动窗口
         2. 累计确认
         3. 回退N帧

6. TCP首部：

1. 1. 前20 Byte固定（20~60, 4 bit首部偏移长度 单位为4 Byte 15*4=60 Byte）

   2. 2个端口（1个2 Byte）+ 2个编号（1个4 Byte 序号+确认号）

   3. 4位 首部长 + 6位保留 + 6位（URG 紧急；PSH立即响应，很少用；ACK连接建立后=1；RST 释放链接；SYN =1, ACK=0连接请求，SYN=1, ACK=1接受请求；FIN发送方完毕，要求释放）

   4. 窗口值：接收方要求发送方参考自己缓存空间 e.g. ACK=701, 窗口=1000（701～1700）注意不是ACK不是700 ACK表示期待

   5. 校验和依旧有12 Byte伪首部

   6. 选项：

   7. 1. MSS(Max Segment Size) 635+20=656；
      2. 窗口扩大：3 Byte 最大值14 所以2^(16+14)-1=2^30-1 窗口大小
      3. 时间戳：10 Byte 主要：时间戳值(4 Byte), 时间戳回送回答(4 Byte) 功能：计算RTT；防止序号绕回PASW



7. TCP可靠传输

1. 1. 滑动窗口

​		以字节为单位；3指针的滑动窗口(前沿: 接收方没有存储空间；后沿: 已确认；中间指针: 发送未确认)

​		发送方保留未确认副本；接收方可适当延迟确认已减少重传浪费

​		发送窗口并不一定=接受窗口（根据拥塞情况适当减小发送窗口）

​		接收方：累计确认 另外自己发送消息时也要捎带确认 但不能延迟过长(<0.5s) 收到最大长度报文段要立即确认

1. 1. 超时重传时间的选择

​		类似LSTM的记忆率 由RTT决定 自适应算法 RTO = RTTs(往返时间的记忆) + 4*RTTd(偏差的记忆)

1. 1. 选择确认SACK（进一步减少重传浪费 不连续确认）

​		需要在TCP首部允许使用SACK 首部选项长度最长40字节 2字节用来指明使用SACK和指明选项是用多少字节

​		所以最多可指明4对(8个)指针 (每个指针4字节 即确认号)

​		左边界和右边界（比如 L1=1501, R1=3001(不是3000))



8. TCP流量控制

1. 1. 利用滑动窗口 

​	几个选项：发送方seq=1, Data(1~200) 接收方：ACK=1, ack=201, rwnd=300

​	这个rwnd就是根据接收方存储空间来调节可变窗口大小来实现流量控制

​	有个问题：如果发送窗口=0, 而接收方rwnd丢失时会产生“死锁”；解决：设置持续计时器 接收方计时到就发送0窗口（1字节）探测报文段

1. 1. 考虑传输效率

​		发送方一次不要发送很短的报文；接收方也不要一有一点空间就确认(等待一段时间 或 有一半空闲空间再确认)



9. TCP拥塞控制		

1. 1. 开环(先设计好 开始后不能停)和闭环(动态处理)

   2. 监测指标：没缓存被丢的分组的比例, 平均队列长度, 超时重传的分组数量, 平均分组时延等

   3. 拥塞控制方法：

   4. 1. 慢开始(slow-start)：通过限制拥塞窗口（判断拥塞依据就是超时, 现在网络很好）确认窗口就加倍 慢开始门限
      2. 拥塞避免：加1 而不是加倍 （窗口<慢开始门限用慢开始；窗口>门限用拥塞避免）
      3. 快重传：收不到M3 立即对M2确认 然后收到M4 M5 都确认M2 这样接收方连续收到3个M2确认就知道M3要重传
      4. 快恢复：个别丢失不直接起用慢开始 而是将窗口除以2；也有的把窗口+3MSS(3个连续确认) 

   5. 主动队列管理AQM：2个门限 current<最小门限接收；最小门限<current<最大门限则丢弃；中间则设丢弃率



10. TCP连接管理（重点）

1. 1. 三次握手





​		SYN=1, seq=x

​		ACK=1, ack=x+1; SYN=1, seq=y

​		ACK=1, ack=y+1, seq=x+1(不消耗序号 下次还是x+1)

​		第三次握手的原因：防止已失效的连接请求报文突然传给B，B以为是新的请求并同意了，造成空等



1. 1. 四次挥手





​		FIN=1，seq=u（A进入FIN-WAIT-1）

​		ACK=1, ack=u+1, seq=v（B先确认收到了 B进入CLOSE-WAIT A进入FIN-WAIT-2）

​		ACK=1, ack=u+1, FIN=1, seq=w(可能B又发了一些)（B进入LAST-ACK）

​		ACK=1, ack=w+1, seq=u+1(A进入TIME-WAIT)（B就CLOSED了 A进入TIME-WAIT）

​		经过2*MSL(最长报文段寿命)之后 A没有收到B的超时重传ACK+FIN报文的话 A最终CLOSED

​	

​		总结一下：

​		A要进入三个状态：FIN-WAIT-1, FIN-WAIT-2, TIME-WAIT 之后才CLOSED

​		B要进入两个状态：CLOSE-WAIT, LAST-ACK 之后才进入CLOSED

​		A TIME-WAIT的原因：如果B没收到 会超时重传 如果重传需要A也重传

​		除了以上 还要有个保活计时器(keepalive timer) 如果主机突然崩了 发不了报文 则超时结束连接